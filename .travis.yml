language: c++
sudo: required
notifications:
  email:
    recipients:
      - dagmcci@googlegroups.com
  slack: cnerg:d48My26ZXfvHlg0On2WwNQFi
services:
  - docker
env:
  - UBUNTU_VERSION=18.04 ASTYLE_ONLY=ON
  - UBUNTU_VERSION=16.04 COMPILER=gcc   MOAB_VERSION=5.1.0
  - UBUNTU_VERSION=16.04 COMPILER=clang MOAB_VERSION=5.1.0
  - UBUNTU_VERSION=18.04 COMPILER=gcc   MOAB_VERSION=5.1.0
  - UBUNTU_VERSION=18.04 COMPILER=clang MOAB_VERSION=5.1.0
  - UBUNTU_VERSION=16.04 COMPILER=gcc   MOAB_VERSION=master
  - UBUNTU_VERSION=16.04 COMPILER=clang MOAB_VERSION=master
  - UBUNTU_VERSION=18.04 COMPILER=gcc   MOAB_VERSION=master
  - UBUNTU_VERSION=18.04 COMPILER=clang MOAB_VERSION=master
matrix:
  fast_finish: true
  allow_failures:
    - env: UBUNTU_VERSION=16.04 COMPILER=gcc   MOAB_VERSION=master
    - env: UBUNTU_VERSION=16.04 COMPILER=clang MOAB_VERSION=master
    - env: UBUNTU_VERSION=18.04 COMPILER=gcc   MOAB_VERSION=master
    - env: UBUNTU_VERSION=18.04 COMPILER=clang MOAB_VERSION=master
before_install:
  - docker_image=ljacobson64/dagmc-ci-ubuntu-$UBUNTU_VERSION
  - build_dir=/root/build/$COMPILER/DAGMC-moab-$MOAB_VERSION
  # Get the docker image
  - docker pull $docker_image
  # Make the build directory
  - docker run $docker_image /bin/bash -c "mkdir -p $build_dir"
  - commit_id=$(docker ps -l | tail -n1 | awk '{print $1}')
  - docker commit $commit_id $docker_image
  # Copy the repo in the docker instance
  - docker cp ../DAGMC $commit_id:$build_dir
  - commit_id=$(docker ps -l | tail -n1 | awk '{print $1}')
  - docker commit $commit_id $docker_image
install:
  # Build DAGMC
  - docker run $docker_image /bin/bash -c "bash $build_dir/DAGMC/docker/travis.install.sh $ASTYLE_ONLY $COMPILER $MOAB_VERSION"
  - commit_id=$(docker ps -l | tail -n1 | awk '{print $1}')
  - docker commit $commit_id $docker_image
script:
  # Run unit tests
  - docker run $docker_image /bin/bash -c "bash $build_dir/DAGMC/docker/travis.script.sh $ASTYLE_ONLY $COMPILER $MOAB_VERSION"
